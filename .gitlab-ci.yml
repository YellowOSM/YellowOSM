stages:
  - build
  - deploy

build_frontend:
  stage: build
  image: node:latest
  script:
    - npm install -g @angular/cli
    - npm --version
    - ng --version
    - echo 'hello world'
    - ls -a
    - cd frontend
    - npm install
    - ng build --prod --build-optimizer=false
    - ls -R dist
  artifacts:
    paths:
      - dist
    expire_in: 3 weeks
  only:
    - master

deploy_frontend:
  before_script:
    - 'which ssh-agent || ( apt-get update -y && apt-get install openssh-client git -y )'
    - eval $(ssh-agent -s)
    ## DON'T use protected variables for this!!
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add - > /dev/null
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - echo "$SSH_KNOWN_HOSTS" >> ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts
    - ping -c 1 toddvm5.klienux.net

  stage: deploy
  image: node:latest
  script:
    - ls -R dist
    - scp -r dist/frontend root@toddvm5.klienux.net:/srv/html_new
    - ssh root@toddvm5.klienux.net 'mv /srv/html /srv/html_old; mv /srv/html_new /srv/html; rm -r /srv/html_old'
    - ssh root@toddvm5.klienux.net cat yellowosm_success.txt
  only:
    - master
